
name: Build and Test FastAPI Backend with Poetry

defaults:
  run:
    shell: bash
    working-directory: ./backend

on:
    push:
        branches: [ "master", "dev" ]
        paths:
        - "backend/**"
#    pull_request:
#        branches: [ "master", "dev" ]
#        paths:
#        - "backend/**"
    workflow_dispatch:

jobs:
    build:
      runs-on: ubuntu-latest
      steps:
        - name: Check out repository
          uses: actions/checkout@v3
        - name: Set up python
          id: setup-python
          uses: actions/setup-python@v4
          with:
            python-version: '3.9'
        - name: Install Poetry
          uses: snok/install-poetry@v1
          with:
            virtualenvs-create: true
            virtualenvs-in-project: true
        # TODO: cache these dependencies
        - name: Install dependencies
          run: poetry install
        - name: Lint with flake8
          run: |
            poetry run flake8 . --count --select=E9,F63,F7,F82 --show-source --statistics
            poetry run flake8 . --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics
        # TODO: use mypy cache to speed up this step if possible
        - name: Lint with mypy
          run: poetry run mypy .
        - name: Test with pytest
          run: poetry run pytest tests


